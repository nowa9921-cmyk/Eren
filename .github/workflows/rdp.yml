name: Windows RDP + Tailscale + Eren Setup

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:

      # Step 0: Checkout
      - uses: actions/checkout@v4

      # Step 1: Enable RDP & create user safely
      - name: Enable RDP and create user
        shell: pwsh
        run: |
          $User = "Eren_Yeager"
          $Pass = "Mikasa_Yeager"

          Write-Host "=== Enabling RDP ==="
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Write-Host "=== Creating or updating user safely ==="
          if (-not (Get-LocalUser -Name $User -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $User -Password (ConvertTo-SecureString $Pass -AsPlainText -Force)
              Add-LocalGroupMember -Group "Administrators" -Member $User
              Write-Host "User $User created and added to Administrators."
          } else {
              Set-LocalUser -Name $User -Password (ConvertTo-SecureString $Pass -AsPlainText -Force)
              Write-Host "Password for $User updated successfully."
          }

      # Step 2: Create Tools folder
      - name: Create Tools folder
        shell: pwsh
        run: mkdir C:\Tools

      # Step 3: Download Telegram + WinRAR
      - name: Download Apps
        shell: pwsh
        run: |
          curl.exe -L "https://telegram.org/dl/desktop/win/Telegram.exe" -o "C:\Tools\telegram.exe"
          curl.exe -L "https://www.rarlab.com/rar/winrar-x64-621.exe" -o "C:\Tools\winrar.exe"

      # Step 4: Download & install Tailscale
      - name: Download Tailscale
        shell: pwsh
        run: curl.exe -L "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe" -o "C:\Tools\tailscale.exe"

      - name: Install Tailscale silently
        shell: pwsh
        run: Start-Process "C:\Tools\tailscale.exe" -ArgumentList "/S" -Wait

      # Step 5: Start Tailscale and login
      - name: Start Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        shell: pwsh
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname=GitHub-RDP

      # Step 6: Keep Runner Alive + Show RDP Info
      - name: Keep Runner Alive + Show RDP Info
        shell: pwsh
        run: |
          Write-Host "====================================="
          Write-Host "RDP READY!"
          Write-Host "Server (Tailscale IP):"
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "Username: Eren_Yeager"
          Write-Host "Password: Mikasa_Yeager"
          Write-Host "Apps installed in C:\Tools"
          Write-Host "Wallpaper step skipped to avoid errors"
          Write-Host "Keep this window open to maintain RDP access"
          Write-Host "====================================="
          Start-Sleep -Seconds 3000
