name: Windows RDP + Tailscale + Eren Full Setup

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:

      # Step 1: Enable RDP & create user
      - name: Enable RDP and create user
        shell: pwsh
        run: |
          $User = "Eren_Yeager"
          $Pass = "Mikasa_Ackerman"

          Write-Host "=== Enabling RDP ==="
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Write-Host "=== Creating or updating user ==="
          if (-not (Get-LocalUser -Name $User -ErrorAction SilentlyContinue)) {
              net user "$User" "$Pass" /add
              Write-Host "User $User created."
          } else {
              net user "$User" "$Pass"
              Write-Host "Password updated for $User."
          }

          Write-Host "=== Adding user to Administrators group ==="
          try {
              Add-LocalGroupMember -Group "Administrators" -Member $User
              Write-Host "$User added to Administrators."
          } catch {
              Write-Host "$User is already Administrator."
          }

      # Step 2: Create Tools folder
      - name: Create Tools folder
        shell: pwsh
        run: mkdir C:\Tools

      # Step 3: Download Telegram + WinRAR
      - name: Download Apps
        shell: pwsh
        run: |
          curl.exe -L "https://telegram.org/dl/desktop/win/Telegram.exe" -o "C:\Tools\telegram.exe"
          curl.exe -L "https://www.rarlab.com/rar/winrar-x64-621.exe" -o "C:\Tools\winrar.exe"

      # Step 4: Download & install Tailscale
      - name: Download Tailscale
        shell: pwsh
        run: curl.exe -L "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe" -o "C:\Tools\tailscale.exe"

      - name: Install Tailscale silently
        shell: pwsh
        run: Start-Process "C:\Tools\tailscale.exe" -ArgumentList "/S" -Wait

      # Step 5: Start Tailscale and login
      - name: Start Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        shell: pwsh
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname=GitHub-RDP

      # Step 6: Download wallpapers & start slideshow
      - name: Eren Wallpapers Auto-Change
        shell: pwsh
        run: |
          $wallFolder = "C:\Tools\Wallpapers"
          if (-not (Test-Path $wallFolder)) { New-Item -ItemType Directory -Path $wallFolder }

          $wallpapers = @(
              "https://i.imgur.com/UoPRCob.jpeg",
              "https://i.imgur.com/yoti0KT.jpeg",
              "https://i.imgur.com/2IfezjK.jpeg"
          )

          foreach ($url in $wallpapers) {
              $file = Join-Path $wallFolder ("wallpaper{0}.jpeg" -f ($wallpapers.IndexOf($url)+1))
              Invoke-WebRequest -Uri $url -OutFile $file
          }

          # Create slideshow script separately to avoid YAML errors
          $slideshowScript = "C:\Tools\wallpaper_slideshow.ps1"
          @'
function Set-Wallpaper($path) {
    $code = @"
using System.Runtime.InteropServices;
public class Wallpaper {
    [DllImport(""user32.dll"", SetLastError=true)]
    public static extern bool SystemParametersInfo(int uAction, int uParam, string lpvParam, int fuWinIni);
}
"@
    Add-Type $code
    [Wallpaper]::SystemParametersInfo(20, 0, $path, 3)
}

$walls = Get-ChildItem "C:\Tools\Wallpapers"
while ($true) {
    foreach ($wall in $walls) {
        Set-Wallpaper $wall.FullName
        Start-Sleep -Seconds 10
    }
}
'@ | Out-File -FilePath $slideshowScript -Encoding UTF8

          # Start slideshow as background process
          Start-Process pwsh -ArgumentList "-File `"$slideshowScript`"" -WindowStyle Hidden
          Write-Host "Wallpaper slideshow started (10s interval)"

      # Step 7: Keep Runner Alive + Show RDP Info
      - name: Keep Runner Alive + Show RDP Info
        shell: pwsh
        run: |
          Write-Host "====================================="
          Write-Host "RDP READY!"
          Write-Host "Server (Tailscale IP):"
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "Username: Eren_Yeager"
          Write-Host "Password: Mikasa_Ackerman"
          Write-Host "Apps installed in C:\Tools"
          Write-Host "Wallpaper slideshow every 10 seconds is active"
          Write-Host "Keep this window open to maintain RDP access"
          Write-Host "====================================="
          Start-Sleep -Seconds 3000
