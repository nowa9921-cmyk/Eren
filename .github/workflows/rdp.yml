name: Windows RDP + Tailscale + Eren Setup

on:
  workflow_dispatch:

concurrency:
  group: rdp-setup
  cancel-in-progress: true   # ensures only one run at a time

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      # Enable RDP & create user safely
      - name: Enable RDP and create user
        shell: pwsh
        run: |
          $User = "Eren_Yeager"
          $Pass = "Mikasa_Yeager"

          Write-Host "=== Enabling RDP ==="
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          Write-Host "=== Creating or updating user safely ==="
          if (-not (Get-LocalUser -Name $User -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $User -Password (ConvertTo-SecureString $Pass -AsPlainText -Force)
              Add-LocalGroupMember -Group "Administrators" -Member $User
              Write-Host "User $User created and added to Administrators."
          } else {
              Set-LocalUser -Name $User -Password (ConvertTo-SecureString $Pass -AsPlainText -Force)
              Write-Host "Password for $User updated successfully."
          }

      # Create Tools folder safely
      - name: Create Tools folder
        shell: pwsh
        run: |
          $toolsFolder = "C:\Tools"
          if (-not (Test-Path $toolsFolder)) {
              New-Item -ItemType Directory -Path $toolsFolder
              Write-Host "$toolsFolder created."
          } else {
              Write-Host "$toolsFolder already exists, skipping creation."
          }

      # Download Telegram + WinRAR
      - name: Download Apps
        shell: pwsh
        run: |
          curl.exe -L "https://telegram.org/dl/desktop/win/Telegram.exe" -o "C:\Tools\telegram.exe"
          curl.exe -L "https://www.rarlab.com/rar/winrar-x64-621.exe" -o "C:\Tools\winrar.exe"

      # Download Tailscale CLI installer (headless-safe)
      - name: Download Tailscale MSI
        shell: pwsh
        run: |
          Invoke-WebRequest "https://pkgs.tailscale.com/stable/tailscale-setup.msi" -OutFile "C:\Tools\tailscale.msi"

      # Install Tailscale silently
      - name: Install Tailscale silently
        shell: pwsh
        run: Start-Process "msiexec.exe" -ArgumentList "/i C:\Tools\tailscale.msi /qn /norestart" -Wait

      # Start Tailscale CLI
      - name: Start Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        shell: pwsh
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname=GitHub-RDP

      # Keep Runner Alive + Show RDP Info
      - name: Keep Runner Alive + Show RDP Info
        shell: pwsh
        run: |
          Write-Host "====================================="
          Write-Host "RDP READY!"
          Write-Host "Server (Tailscale IP):"
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "Username: Eren_Yeager"
          Write-Host "Password: Mikasa_Yeager"
          Write-Host "Apps installed in C:\Tools"
          Write-Host "Wallpaper step skipped"
          Write-Host "Keep this window open to maintain RDP access"
          Write-Host "====================================="
          Start-Sleep -Seconds 3000
