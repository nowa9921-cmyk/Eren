name: Windows RDP + Tailscale Full

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:
      - name: Enable RDP and set credentials
        env:
          RDP_USER: ${{ secrets.RDP_USERNAME }}
          RDP_PASS: ${{ secrets.RDP_PASSWORD }}
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user $env:RDP_USER $env:RDP_PASS

      - name: Create Tools Folder
        run: mkdir C:\Tools

      - name: Download Apps
        run: |
          curl.exe -L "https://telegram.org/dl/desktop/win/Telegram.exe" -o "C:\Tools\telegram.exe"
          curl.exe -L "https://www.rarlab.com/rar/winrar-x64-621.exe" -o "C:\Tools\winrar.exe"

      - name: Download Tailscale
        run: |
          curl.exe -L "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe" -o "C:\Tools\tailscale.exe"

      - name: Install Tailscale
        run: |
          Start-Process "C:\Tools\tailscale.exe" -ArgumentList "/S" -Wait

      - name: Start Tailscale and Login
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TS_AUTHKEY --hostname=GitHub-RDP

      - name: Show Tailscale IP
        run: |
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4

      - name: Keep Runner Alive
        env:
          RDP_USER: ${{ secrets.RDP_USERNAME }}
        run: |
          Write-Host "====================================="
          Write-Host "RDP READY!"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Use the Tailscale IP above in Remote Desktop"
          Write-Host "Keeping system alive for 50 minutes..."
          Write-Host "====================================="
          Start-Sleep -Seconds 3000
